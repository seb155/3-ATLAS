# Session ECHO - 2025-12-02

## Objectif Initial
Tester la transcription FR-QC et résoudre les problèmes de performance.

## Problèmes Identifiés et Corrigés

### 1. Bug API Settings Reload
**Fichier:** `backend/app/api/endpoints/settings.py` ligne 247

**Problème:** L'API `/settings/whisper/reload` appelait `initialize(force_reload=True)` mais la méthode n'accepte pas ce paramètre.

**Fix:**
```python
# Avant (bug)
success = transcription_service.initialize(force_reload=True)

# Après (corrigé)
active_device = transcription_service.initialize()
```

### 2. Bug Singleton Model Size
**Fichier:** `backend/app/services/whisper_local.py` ligne 130-133

**Problème:** Le `LocalWhisperService` est un singleton. Quand on changeait le modèle via l'API, `settings.whisper_model` changeait mais `self.model_size` (assigné à l'init) gardait l'ancienne valeur.

**Fix:** Relire les settings dans `load_model()` avant de charger:
```python
def load_model(self, force_reload: bool = False) -> bool:
    # ...
    # Re-read settings in case they changed (e.g., via API)
    self.model_size = settings.whisper_model
    self.device = settings.whisper_device
    self.compute_type = settings.whisper_compute_type
```

### 3. Performance CPU Lente
**Cause:** Backend dans Docker → pas d'accès au NPU AMD Ryzen AI

**Solution:** Mode Hybride
- Frontend reste dans Docker (port 7200)
- Backend tourne nativement sur Windows avec accès NPU (port 7201)

## Fichiers Créés

| Fichier | Description |
|---------|-------------|
| `docker-compose.hybrid.yml` | Frontend Docker seul, backend natif |
| `.dev/scripts/echo-mode.ps1` | Script PowerShell pour switcher Docker ↔ Hybride |

## Fichiers Modifiés

| Fichier | Changement |
|---------|------------|
| `backend/app/api/endpoints/settings.py` | Fix reload API |
| `backend/app/services/whisper_local.py` | Fix singleton + re-read settings |
| `.dev/scripts/echo-backend-manager.ps1` | CORS host.docker.internal, model large-v3 |

## Tests Effectués

### Transcription FR-QC
- **Input:** Audio bilingue FR/EN (~11s)
- **Output (small):** "Un, deux, patate, que tu m'entends? Aujourd'hui, j'ai été à la piscine, puis j'ai fait caca dans l'eau. I shit in the water. My name is Sebastian."
- **Output (medium):** "...pis j'ai fait caca..." (détecte "pis" québécois)
- **Code-switching:** ✅ FR → EN détecté correctement

### API Settings
- GET /settings/whisper ✅
- POST /settings/whisper (change model) ✅
- POST /settings/whisper/reload ✅ (après fix)

## Performance Attendue (Mode Hybride)

| Modèle | CPU Docker | NPU Natif |
|--------|------------|-----------|
| base | ~5s | ~2s |
| medium | ~15s | ~5s |
| large-v3 | ~45s | ~10s |

## Commandes Utiles

### Démarrer Mode Hybride (NPU)
```powershell
cd D:\Projects\AXIOM\apps\echo
.\.dev\scripts\echo-mode.ps1 -Mode hybrid -Action start
```

### Démarrer Mode Docker (CPU)
```powershell
.\.dev\scripts\echo-mode.ps1 -Mode docker -Action start
```

### Vérifier Status
```powershell
.\.dev\scripts\echo-mode.ps1 -Action status
```

### Vérifier NPU
```bash
curl -s http://localhost:7201/api/v1/health | jq '.details.npu_available'
```

## Commit
```
82c43f75 feat(echo): add hybrid mode for NPU acceleration + desktop features
```

## Prochaines Étapes
1. Tester mode hybride sur Windows avec NPU
2. Vérifier performance réelle NPU vs CPU
3. Améliorer system tray (indicateur recording)
4. Tests unitaires backend
