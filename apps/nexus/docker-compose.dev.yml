# ==============================================================================
# NEXUS - Development Mode (Workspace Integration)
# ==============================================================================
# Connects to EPCB-Tools workspace infrastructure
#
# Usage:
#   From workspace: cd D:\Projects\EPCB-Tools\workspace
#                   docker-compose -f ../apps/nexus/docker-compose.dev.yml up -d
#
#   With Traefik:   docker-compose -f ../apps/nexus/docker-compose.dev.yml \
#                                  -f ../apps/nexus/docker-compose.traefik-labels.yml up -d
#
# Prerequisites:
#   - forge-network must exist (created by workspace/docker-compose.yml)
#   - forge-postgres must be running
#   - forge-redis must be running
# ==============================================================================

services:
  # ============================================================================
  # BACKEND - FastAPI Application
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: nexus-backend
    ports:
      - "8000:8000"  # Direct port access (http://localhost:8000)
    volumes:
      - ./backend:/app
      - backend-cache:/app/__pycache__
      - backend-venv:/app/.venv  # Persist virtual environment
    environment:
      # ========================================================================
      # DATABASE CONFIGURATION (FORGE PostgreSQL)
      # ========================================================================
      DATABASE_URL: postgresql://postgres:postgres@forge-postgres:5432/nexus
      AUTH_DATABASE_URL: postgresql://postgres:postgres@forge-postgres:5432/postgres?options=-csearch_path%3Dworkspace_auth
      POSTGRES_SERVER: forge-postgres
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: nexus

      # ========================================================================
      # REDIS CONFIGURATION (Workspace Redis with key prefix)
      # ========================================================================
      REDIS_URL: redis://forge-redis:6379
      REDIS_KEY_PREFIX: "nexus:"

      # ========================================================================
      # JWT AUTHENTICATION (Shared secret for workspace SSO)
      # ========================================================================
      # IMPORTANT: This SECRET_KEY must match across all workspace apps
      # for SSO to work (Nexus, Synapse, etc.)
      SECRET_KEY: ${WORKSPACE_SECRET_KEY:-dev-secret-key-change-in-production-min-32-chars}
      ALGORITHM: HS256
      ACCESS_TOKEN_EXPIRE_MINUTES: 60
      REFRESH_TOKEN_EXPIRE_DAYS: 30

      # ========================================================================
      # CORS CONFIGURATION
      # ========================================================================
      CORS_ORIGINS: "http://localhost:5173,https://nexus.localhost,https://nexus.axoiq.com,https://api-nexus.axoiq.com"

      # ========================================================================
      # APPLICATION SETTINGS
      # ========================================================================
      ENVIRONMENT: development
      DEBUG: "true"
      LOG_LEVEL: DEBUG
      APP_NAME: Nexus
      APP_VERSION: 0.2.0

      # ========================================================================
      # LOGGING (Loki integration)
      # ========================================================================
      LOKI_URL: http://loki:3100

    labels:
      # Promtail logging labels
      logging: "promtail"
      logging_jobname: "nexus-backend"

    command: uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
    networks:
      - forge-network
    restart: unless-stopped
    # Note: forge-postgres and forge-redis are external services
    # They must be running before starting Nexus

    healthcheck:
      test: ["CMD", "python", "-c", "import requests; requests.get('http://localhost:8000/api/v1/health')"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # ============================================================================
  # FRONTEND - React + Vite Development Server
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: nexus-frontend
    ports:
      - "5173:5173"  # Direct port access (http://localhost:5173)
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/index.html:/app/index.html
      - ./frontend/package.json:/app/package.json
      - ./frontend/package-lock.json:/app/package-lock.json
      - ./frontend/vite.config.ts:/app/vite.config.ts
      - ./frontend/tailwind.config.js:/app/tailwind.config.js
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tsconfig.app.json:/app/tsconfig.app.json
      - ./frontend/tsconfig.node.json:/app/tsconfig.node.json
      - /app/node_modules  # Prevent overwriting node_modules
    environment:
      # ========================================================================
      # API ENDPOINT CONFIGURATION
      # ========================================================================
      # Direct port (for development without Traefik)
      VITE_API_URL: ${VITE_API_URL:-http://localhost:8000}

      # Traefik route (for production-like setup)
      VITE_API_URL_TRAEFIK: https://api-nexus.${DOMAIN:-localhost}

      # ========================================================================
      # APPLICATION SETTINGS
      # ========================================================================
      NODE_ENV: development
      VITE_APP_NAME: Nexus
      VITE_APP_VERSION: 0.2.0

    labels:
      # Promtail logging labels
      logging: "promtail"
      logging_jobname: "nexus-frontend"

    networks:
      - forge-network
    depends_on:
      - backend
    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:5173"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

# ==============================================================================
# VOLUMES
# ==============================================================================
volumes:
  backend-cache:
    driver: local
  backend-venv:
    driver: local

# ==============================================================================
# NETWORKS
# ==============================================================================
networks:
  forge-network:
    external: true
    name: forge-network

# ==============================================================================
# NOTES
# ==============================================================================
# 1. This compose file expects workspace infrastructure to be running:
#    - forge-postgres (PostgreSQL 15)
#    - forge-redis (Redis 7)
#    - forge-network (Docker bridge network)
#
# 2. Start workspace first:
#    cd D:\Projects\EPCB-Tools\workspace
#    docker-compose up -d
#
# 3. Then start Nexus:
#    docker-compose -f ../apps/nexus/docker-compose.dev.yml up -d
#
# 4. Access:
#    - Frontend: http://localhost:5173
#    - Backend API: http://localhost:8000/docs
#    - With Traefik: https://nexus.localhost, https://api-nexus.localhost
#
# 5. Logs:
#    - View in Grafana: http://localhost:3000
#    - Query: {logging_jobname="nexus-backend"} or {logging_jobname="nexus-frontend"}
#
# 6. Database:
#    - Connect: docker exec -it forge-postgres psql -U postgres -d nexus
#    - Auth DB: \c postgres; SET search_path TO workspace_auth; SELECT * FROM users;
# ==============================================================================
