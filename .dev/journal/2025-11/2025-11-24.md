# Journal - 2025-11-24

## Logging & Monitoring Infrastructure

### Added Loki + Grafana Stack

Implemented centralized logging for SYNAPSE:

**New Services in workspace:**
- **Loki** (port 3100) - Log aggregation database
- **Grafana** (port 3000) - Log visualization dashboard
- **Promtail** - Log collector (Docker socket integration)

**Configuration files:**
- `workspace/config/loki/loki-config.yaml`
- `workspace/config/promtail/promtail-config.yaml`
- `workspace/config/grafana/provisioning/datasources/datasources.yaml`
- `workspace/config/grafana/provisioning/dashboards/dashboards.yaml`
- `workspace/config/grafana/provisioning/dashboards/synapse-logs.json`

### Grafana Dashboard

Created pre-provisioned dashboard "SYNAPSE Logs" with:
- **Stats panels:** Total Logs, Errors, Warnings, Write Operations (1h)
- **Log viewer:** Full-text search with `$search` variable
- **Log volume:** Time series graph
- **Logs by level:** Pie chart breakdown
- **Errors panel:** Filtered error-only view
- **Auto-refresh:** 5 seconds

### WebSocket Real-time Logs (DevConsole)

Complete redesign of DevConsole log streaming:

**Backend architecture:**
- `LoggingMiddleware` - Captures all HTTP requests/responses
- `WebSocketLogger` - Central logging with storage + broadcast
- `ConnectionManager` - WebSocket client management
- `/ws/logs` - WebSocket endpoint with ping/pong keepalive
- `/api/v1/logs/` - HTTP fallback for log history

**Log flow:**
```
HTTP Request → LoggingMiddleware → WebSocketLogger
                                      ├── Store in memory (1000 max)
                                      ├── Print JSON (for Promtail)
                                      └── Broadcast to WebSocket clients
```

**Frontend integration:**
- `useLogStore.ts` - WebSocket state management + auto-reconnect
- `DevConsole.tsx` - Live status indicator (green=connected)
- `config.ts` - WS_URL derived from API_URL

### Files Created/Modified

**New files:**
- `apps/synapse/backend/app/middleware/__init__.py`
- `apps/synapse/backend/app/middleware/logging_middleware.py`
- `workspace/config/grafana/provisioning/dashboards/synapse-logs.json`

**Modified files:**
- `apps/synapse/backend/app/services/websocket_manager.py`
- `apps/synapse/backend/app/api/endpoints/logs.py`
- `apps/synapse/backend/app/main.py` (added middleware)
- `workspace/docker-compose.yml` (added Loki, Grafana, Promtail)

### Testing Results

- ✅ Loki receiving logs (4 streams with proper labels)
- ✅ Grafana dashboard auto-provisioned
- ✅ WebSocket connection stable (1 client)
- ✅ Logs stored and retrievable via HTTP
- ✅ Real-time broadcast working

### Access Points

| Service | URL | Credentials |
|---------|-----|-------------|
| Grafana | http://localhost:3000 | admin / xZfFu3&FZCBe |
| Loki API | http://localhost:3100/ready | - |
| DevConsole | Frontend (Ctrl+`) | - |

---

**Time spent:** ~3 hours
**Status:** Complete ✅
