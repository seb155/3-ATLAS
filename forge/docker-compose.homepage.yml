# HOMEPAGE - Application Dashboard
# Usage: docker-compose -f docker-compose.yml -f docker-compose.traefik.yml -f docker-compose.homepage.yml up -d
# Access: https://portal.localhost

services:
  homepage:
    image: ghcr.io/gethomepage/homepage:latest
    container_name: forge-homepage
    environment:
      PUID: 1000
      PGID: 1000
      # Allow access from any host (dev environment)
      # For production, specify exact domains: home.yourdomain.com
      HOMEPAGE_ALLOWED_HOSTS: "localhost:3333,localhost:3000,home.localhost"
      # Force HTTP in dev (no HTTPS redirect)
      HOMEPAGE_USE_HTTPS: "false"
    ports:
      - "3333:3000"  # Direct access (works on Windows + Linux)
    volumes:
      - ./homepage/config:/app/config
      - /var/run/docker.sock:/var/run/docker.sock:ro  # Docker integration
      - ./homepage/images:/app/public/images
      - ./homepage/icons:/app/public/icons
    networks:
      - forge-network
    labels:
      - "traefik.enable=true"

      # HTTP Router
      - "traefik.http.routers.homepage.rule=Host(`home.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.homepage.entrypoints=websecure"
      - "traefik.http.routers.homepage.tls.certresolver=letsencrypt"
      - "traefik.http.services.homepage.loadbalancer.server.port=3000"

      # Middleware: Headers
      - "traefik.http.middlewares.homepage-headers.headers.customResponseHeaders.X-Robots-Tag=noindex,nofollow"
      - "traefik.http.routers.homepage.middlewares=homepage-headers"

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3

networks:
  forge-network:
    external: true
