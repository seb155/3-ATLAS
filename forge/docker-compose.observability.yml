# FORGE - Claude Code Observability Stack PRO
# Usage: docker-compose -f docker-compose.yml -f docker-compose.observability.yml up -d
#
# Services:
#   - Prometheus: Time-series metrics storage (port 3090)
#   - OpenTelemetry Collector: Receives telemetry from Claude Code (ports 3200/3201)
#   - ccusage-exporter PRO: Advanced metrics with optimization insights (port 3202)
#
# Endpoints:
#   - http://localhost:3202/metrics  - Prometheus metrics
#   - http://localhost:3202/health   - Health check
#   - http://localhost:3202/insights - Optimization insights (JSON)
#   - http://localhost:3202/summary  - Quick usage summary (JSON)
#
# Dashboard: https://grafana.axoiq.com -> Claude Code PRO

services:
  # Prometheus - Time-series metrics storage
  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: forge-prometheus
    user: root
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=90d'
      - '--web.enable-lifecycle'
      - '--web.enable-remote-write-receiver'
    volumes:
      - ./config/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./config/prometheus/alerts.yml:/etc/prometheus/alerts.yml:ro
      - prometheus-data:/prometheus
    ports:
      - "3090:9090"
    networks:
      - forge-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9090/-/healthy"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # OpenTelemetry Collector - Receives telemetry from Claude Code
  otel-collector:
    image: otel/opentelemetry-collector-contrib:0.96.0
    container_name: forge-otel-collector
    user: "0:0"
    command: ["--config=/etc/otel/collector-config.yaml"]
    volumes:
      - ./config/otel/collector-config.yaml:/etc/otel/collector-config.yaml:ro
    ports:
      - "3200:4317"   # OTLP gRPC
      - "3201:4318"   # OTLP HTTP
    networks:
      - forge-network
    depends_on:
      prometheus:
        condition: service_healthy
      loki:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:13133/"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # ccusage-exporter PRO - Advanced Claude Code metrics
  # Endpoints:
  #   /metrics  - Prometheus-compatible metrics
  #   /health   - Health check (JSON)
  #   /insights - Optimization recommendations (JSON)
  #   /summary  - Quick usage summary (JSON)
  ccusage-exporter:
    build: ./services/ccusage-exporter
    container_name: forge-ccusage-exporter
    volumes:
      - ${HOME}/.claude/projects:/data/claude-projects:ro
    environment:
      - CLAUDE_PROJECTS_DIR=/data/claude-projects
      - SCRAPE_INTERVAL=60
      - METRICS_PORT=9091
      - CLAUDE_MONTHLY_BUDGET=300  # Max plan budget
      - EXPORTER_VERSION=pro  # Use 'standard' for legacy exporter
    ports:
      - "3202:9091"
    networks:
      - forge-network
    healthcheck:
      test: ["CMD", "wget", "--spider", "-q", "http://localhost:9091/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.ccusage.rule=Host(`ccusage.axoiq.com`)"
      - "traefik.http.routers.ccusage.tls=true"
      - "traefik.http.services.ccusage.loadbalancer.server.port=9091"

volumes:
  prometheus-data:

networks:
  forge-network:
    external: true
