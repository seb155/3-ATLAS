# Traefik Dynamic Configuration
# This file defines routes for all services
# Works with Traefik v3.6.2+ and Docker 29+

http:
  routers:
    # ========================================================================
    # PRODUCTION ROUTES (axoiq.com) - HTTPS with Let's Encrypt
    # ========================================================================

    # Homepage Portal
    homepage-prod:
      rule: "Host(`portal.axoiq.com`)"
      service: homepage
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # SYNAPSE Frontend
    synapse-frontend-prod:
      rule: "Host(`synapse.axoiq.com`)"
      service: synapse-frontend
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # SYNAPSE Backend API
    synapse-backend-prod:
      rule: "Host(`api.axoiq.com`)"
      service: synapse-backend
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # NEXUS Frontend
    nexus-frontend-prod:
      rule: "Host(`nexus.axoiq.com`)"
      service: nexus-frontend
      entryPoints:
        - websecure
      tls: {}  # Use default certificate from certificates.yml

    # NEXUS Backend API
    nexus-backend-prod:
      rule: "Host(`api-nexus.axoiq.com`)"
      service: nexus-backend
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # Grafana
    grafana-prod:
      rule: "Host(`grafana.axoiq.com`)"
      service: grafana
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # Loki
    loki-prod:
      rule: "Host(`loki.axoiq.com`)"
      service: loki
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # pgAdmin
    pgadmin-prod:
      rule: "Host(`pgadmin.axoiq.com`)"
      service: pgadmin
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # Prisma Studio
    prisma-prod:
      rule: "Host(`prisma.axoiq.com`)"
      service: prisma
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # ReportPortal
    reportportal-prod:
      rule: "Host(`reportportal.axoiq.com`)"
      service: reportportal
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # Allure Report
    allure-prod:
      rule: "Host(`allure.axoiq.com`)"
      service: allure
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # Owner Portal
    owner-portal-prod:
      rule: "Host(`owner.axoiq.com`)"
      service: owner-portal
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # Portainer
    portainer-prod:
      rule: "Host(`portainer.axoiq.com`)"
      service: portainer
      entryPoints:
        - websecure
      tls: {}  # Use local mkcert certificate

    # ========================================================================
    # OBSERVABILITY ROUTES (axoiq.com) - Claude Code Statistics
    # ========================================================================

    # Prometheus
    prometheus-prod:
      rule: "Host(`prometheus.axoiq.com`)"
      service: prometheus
      entryPoints:
        - websecure
      tls: {}

    # ========================================================================
    # CODE-SERVER ROUTES (VS Code WebUI)
    # ========================================================================

    # code-server - Main instance (seb)
    code-seb-prod:
      rule: "Host(`code.axoiq.com`)"
      service: code-seb
      entryPoints:
        - websecure
      tls: {}
      middlewares:
        - security-headers
        - rate-limit

    code-seb-dev:
      rule: "Host(`code.localhost`)"
      service: code-seb
      entryPoints:
        - web
      priority: 1

    # ========================================================================
    # PERSONAL PROJECTS ROUTES (axoiq.com) - HTTPS
    # ========================================================================

    # FinDash - Personal Finance Dashboard
    findash-prod:
      rule: "Host(`findash.axoiq.com`)"
      service: findash
      entryPoints:
        - websecure
      tls: {}

    findash-dev:
      rule: "Host(`findash.axoiq.com`)"
      service: findash
      entryPoints:
        - web
      priority: 1

    # ========================================================================
    # REMOTE ACCESS HUB (via Cloudflare Tunnel)
    # ========================================================================

    # Sshwifty - SSH WebUI
    sshwifty-prod:
      rule: "Host(`ssh.axoiq.com`)"
      service: sshwifty
      entryPoints:
        - web  # Cloudflare handles SSL, sends HTTP to Traefik
      priority: 10

    # RustDesk WebSocket
    rustdesk-ws-prod:
      rule: "Host(`rustdesk-ws.axoiq.com`)"
      service: rustdesk-ws
      entryPoints:
        - web  # Cloudflare handles SSL, sends HTTP to Traefik
      priority: 10

    # Headscale VPN Control Server (handled by Docker labels now)
    # Routes managed via docker-compose.headscale.yml labels

    # ========================================================================
    # DEVELOPMENT ROUTES (localhost) - HTTP only
    # ========================================================================

    homepage-dev:
      rule: "Host(`portal.localhost`)"
      service: homepage
      entryPoints:
        - web
      priority: 1

    synapse-frontend-dev:
      rule: "Host(`synapse.localhost`)"
      service: synapse-frontend
      entryPoints:
        - web
      priority: 1

    synapse-backend-dev:
      rule: "Host(`api.localhost`)"
      service: synapse-backend
      entryPoints:
        - web
      priority: 1

    nexus-frontend-dev:
      rule: "Host(`nexus.localhost`)"
      service: nexus-frontend
      entryPoints:
        - web
      priority: 1

    nexus-backend-dev:
      rule: "Host(`api-nexus.localhost`)"
      service: nexus-backend
      entryPoints:
        - web
      priority: 1

    grafana-dev:
      rule: "Host(`grafana.localhost`)"
      service: grafana
      entryPoints:
        - web
      priority: 1

    loki-dev:
      rule: "Host(`loki.localhost`)"
      service: loki
      entryPoints:
        - web
      priority: 1

    pgadmin-dev:
      rule: "Host(`pgadmin.localhost`)"
      service: pgadmin
      entryPoints:
        - web
      priority: 1

    prisma-dev:
      rule: "Host(`prisma.localhost`)"
      service: prisma
      entryPoints:
        - web
      priority: 1

    # Observability - Dev routes
    prometheus-dev:
      rule: "Host(`prometheus.localhost`)"
      service: prometheus
      entryPoints:
        - web
      priority: 1

  services:
    homepage:
      loadBalancer:
        servers:
          - url: "http://forge-homepage:3000"

    synapse-frontend:
      loadBalancer:
        servers:
          - url: "http://synapse-frontend:4000"

    synapse-backend:
      loadBalancer:
        servers:
          - url: "http://synapse-backend:8000"

    grafana:
      loadBalancer:
        servers:
          - url: "http://forge-grafana:3000"

    loki:
      loadBalancer:
        servers:
          - url: "http://forge-loki:3100"

    pgadmin:
      loadBalancer:
        servers:
          - url: "http://forge-pgadmin:80"

    prisma:
      loadBalancer:
        servers:
          - url: "http://forge-prisma:5555"

    nexus-frontend:
      loadBalancer:
        servers:
          - url: "http://nexus-frontend:5173"

    nexus-backend:
      loadBalancer:
        servers:
          - url: "http://nexus-backend:8000"

    reportportal:
      loadBalancer:
        servers:
          - url: "http://reportportal-ui:8080"

    allure:
      loadBalancer:
        servers:
          - url: "http://workspace-allure:5050"

    owner-portal:
      loadBalancer:
        servers:
          - url: "http://owner-portal:80"

    portainer:
      loadBalancer:
        servers:
          - url: "http://portainer:9000"

    # Personal Projects
    findash:
      loadBalancer:
        servers:
          - url: "http://findash-app:6401"

    # code-server (VS Code WebUI)
    code-seb:
      loadBalancer:
        servers:
          - url: "http://forge-code-seb:8443"

    # Observability Services (Claude Code Statistics)
    prometheus:
      loadBalancer:
        servers:
          - url: "http://forge-prometheus:9090"

    # Remote Access Hub
    sshwifty:
      loadBalancer:
        servers:
          - url: "http://forge-sshwifty:8182"

    rustdesk-ws:
      loadBalancer:
        servers:
          - url: "http://forge-rustdesk-hbbs:21118"

    # Headscale VPN (handled by Docker labels)
    # Services managed via docker-compose.headscale.yml

  # ==========================================================================
  # MIDDLEWARES
  # ==========================================================================
  middlewares:
    # Security headers for all services
    security-headers:
      headers:
        stsSeconds: 31536000
        stsPreload: true
        forceSTSHeader: true
        contentTypeNosniff: true
        browserXssFilter: true
        referrerPolicy: "strict-origin-when-cross-origin"
        customFrameOptionsValue: "SAMEORIGIN"

    # Rate limiting to prevent abuse
    rate-limit:
      rateLimit:
        average: 100
        burst: 50
        period: 1s

